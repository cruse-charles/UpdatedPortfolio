<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
	<title>Single - Future Imperfect by HTML5 UP</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="../assets/css/main.css" />
	<link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-okaidia.css" rel="stylesheet" />
</head>

<body class="single is-preload">

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Header -->
		<header id="header">
			<h1><a href="../index.html">Portfolio Site of Charles Cruse</a></h1>
			<nav class="links">
				<ul>
					<li><a href="../aboutme.html">About Me</a></li>
					<li><a href="../assets/Charles_Cruse_Resume.pdf">Resume</a></li>
					<!-- <li><a href="#">Projects</a></li> -->
				</ul>
			</nav>
			<!-- <nav class="main">
                <ul>
                    <li class="search">
                        <a class="fa-search" href="#search">Search</a>
                        <form id="search" method="get" action="#">
                            <input type="text" name="query" placeholder="Search" />
                        </form>
                    </li>
                    <li class="menu">
                        <a class="fa-bars" href="#menu">Menu</a>
                    </li>
                </ul>
            </nav> -->
		</header>

		<!-- Menu -->
		<section id="menu">

			<!-- Search -->
			<!-- <section>
				<form class="search" method="get" action="#">
					<input type="text" name="query" placeholder="Search" />
				</form>
			</section> -->

			<!-- Links -->
			<!-- <section>
				<ul class="links">
					<li>
						<a href="#">
							<h3>Lorem ipsum</h3>
							<p>Feugiat tempus veroeros dolor</p>
						</a>
					</li>
					<li>
						<a href="#">
							<h3>Dolor sit amet</h3>
							<p>Sed vitae justo condimentum</p>
						</a>
					</li>
					<li>
						<a href="#">
							<h3>Feugiat veroeros</h3>
							<p>Phasellus sed ultricies mi congue</p>
						</a>
					</li>
					<li>
						<a href="#">
							<h3>Etiam sed consequat</h3>
							<p>Porta lectus amet ultricies</p>
						</a>
					</li>
				</ul>
			</section> -->

			<!-- Actions -->
			<!-- <section>
				<ul class="actions stacked">
					<li><a href="#" class="button large fit">Log In</a></li>
				</ul>
			</section> -->

		</section>

		<!-- Main -->
		<div id="main">

			<!-- Post -->
			<article class="post">
				<header>
					<div class="title">
						<h2><a href="#">Building A Real App #6</a></h2>
						<p>Follow along with my journey to build a real app</p>
					</div>
					<div class="meta">
						<time class="published" datetime="2025-05-27">May 27, 2025</time>
						<!-- <a href="#" class="author"><span class="name">Jane Doe</span><img src="images/avatar.jpg"
								alt="" /></a> -->
					</div>
				</header>
				<span><img src="../images/BlogImages/Blog6/PhotoHeader.webp" alt="" /></span>
				<h2>Fixing Auth-Based Refresh Issues, Building an Assignment Folder System, and Getting Basic Analytics</h2>
				<p>
					Now that the development period for the project ended, one of the first things I 
					needed to do was update my Firebase rules. During development, I had completely 
					open rules for who could input data so that I could build whatever was needed, 
					but now that I am building out core features, auth is integrated, and I'll have 
					test users soon, I need things to be secure with any incoming requests. However, 
					I was having one big auth issue. 
				</p>
				<h2>The Hard Refresh Problem on Student Pages</h2>
				<p>
					When clicking into a student's page via client-side navigation, everything worked. 
					But refreshing the page triggered this error: FirebaseError: Missing or 
					insufficient permissions.
	
					<br></br>
	
					Redux DevTools showed my state correctly. studentId came from the route params as 
					expected. But looking into it step by step for the actions being called, I saw that 
					the thunk fetchStudent pended and was rejected.
	
					<br></br>
	
					At first, I suspected my Firestore rules since this error was coming around the 
					same time, but I found out that wasn't it. The real issue was a Next.js browser 
					vs. server behavior problem.
				</p>
				<h2>Why the Refresh Fails (But Client Navigation Works)</h2>
				<p>
					The issue was the Next.js App Router trying to render the page on the server 
					during a hard refresh. Here's behavior difference:

					<br></br>
					
					Client-Side Navigation:

					<ul>
						<li>
							Firebase Auth is already initialized.
						</li>
						<li>
							The user has an active JWT in memory.
						</li>
						<li>
							Requests are authenticated ‚Üí Firestore allows them.						
						</li>
					</ul>

					<br></br>

					Hard refresh / direct URL
					<ul>
						<li>
							Next.js prerenders server-side.
						</li>
						<li>
							Firebase Auth does not run on the server.
						</li>
						<li>
							No request.auth token exists.
						</li>
						<li>
							Firestore rejects the request with ‚ÄúMissing or insufficient permissions.‚Äù
						</li>
					</ul>

					So even though Redux ‚Äúhad the right state‚Äù from hydration, the underlying fetch 
					happened without any valid auth context.

				</p>
				<h2>The Fix: Only Fetch After Auth Is Ready on the Client</h2>
				<p>
					The solution was to delay all protected Firestore reads until Firebase Auth is 
					confirmed on the client side.
				</p>
				<pre><code class="language-tsx">
					function StudentProfilePage() {
					const { id: studentId } = useParams();
					const dispatch = useDispatch();
					const [authReady, setAuthReady] = useState(false);

					useEffect(() => {
						const auth = getAuth();
						const unsubscribe = onAuthStateChanged(auth, (user) => {
						if (user) setAuthReady(true);
						});
						return () => unsubscribe();
					}, []);

					useEffect(() => {
						if (authReady && studentId) {
						dispatch(fetchStudent(studentId));
						}
					}, [authReady, studentId, dispatch]);

					// ...
					}

				</code></pre>
				<p>
					This forces a client-only, authenticated-only fetch instead of a server-rendered, 
					unauthenticated one.
				</p>
				<h2>Building a Collapsible Folder System for Student Assignments</h2>
				<p>
					Next, I worked on the interface for viewing assignments. Obviously, I didn't 
					want users to just scroll through a massive list of assignments. The plan is 
					for users to group assignments into folders and let them toggle them open and closed.
				</p>
				<h3>Key goals:</h3>
				<p>
					<ul>
						<li>
							Folders open/close individually
						</li>
						<li>
							Assignments inside each folder are grouped and counted
						</li>
						<li>
							Status badges show progress
						</li>
						<li>
							Folders sort alphabetically (or in the future: by nearest deadlines)
						</li>
						<li>
							Redux pulls assignments by document IDs stored in the student state
						</li>
					</ul>
					Here is the core of how code:
				</p>
				<pre><code class="language-tsx">
					function AssignmentsList() {
						const assignments = useSelector((state) =&gt; state.studentAssignments);
						const folders = useSelector((state) =&gt; (state.student?.folders || []));

						const [openedFolders, setOpenedFolders] = useState([]);

						useEffect(() =&gt; {
							dispatch(fetchAssignments(student.assignmentDocIds));
						}, [studentId]);

						const getFilteredAssignments = (folder) =&gt; {
							return assignments.filter(a =&gt; a.folder === folder);
						};

						return (
							&lt;&gt;
								&lt;Card&gt;
									&lt;CardContent className="p-0"&gt;
										&lt;!-- Loop through each folder --&gt;
										{folders.map((folder) =&gt; (
											&lt;!-- Collapsible folder section --&gt;
											&lt;Collapsible
												key={folder}
												onOpenChange={() =&gt;
													setOpenedFolders(prev =&gt;
														prev.includes(folder) ? prev.filter(f =&gt; f !== folder) : [...prev, folder])}&gt;
													&lt;!-- Folder header (button that opens/closes) --&gt;    
													&lt;CollapsibleTrigger asChild&gt;
													&lt;Button variant="ghost" className="w-full justify-between p-4 border-b"&gt;
														&lt;div className="flex items-center gap-3"&gt;
															{openedFolders.includes(folder) ? &lt;FolderOpen className="h-5 w-5" /&gt; : &lt;Folder className="h-5 w-5" /&gt;}
															&lt;span&gt;{folder}&lt;/span&gt;
														&lt;/div&gt;
														&lt;div className="flex items-center gap-2"&gt;
															{openedFolders.includes(folder) ? &lt;ChevronDown /&gt; : &lt;ChevronRight /&gt;}
														&lt;/div&gt;
													&lt;/Button&gt;
												&lt;/CollapsibleTrigger&gt;

												&lt;!-- Folder content: list of assignments --&gt;
												&lt;CollapsibleContent&gt;
													{getFilteredAssignments(folder).map((assignment) =&gt; (
														&lt;div className="font-medium"&gt;{assignment.title}&lt;/div&gt;
													))}
												&lt;/CollapsibleContent&gt;
											&lt;/Collapsible&gt;
										))}
									&lt;/CardContent&gt;
								&lt;/Card&gt;
							&lt;/&gt;
						);
					}

					export default AssignmentsList;
				</code></pre>
				<h3>Building Analytics Queries in Firebase for the Consultant & Student Dashboards</h3>
				<p>
					Another key feature needed is for consultants and students to see counts and 
					deadlines, which I get from querying Firestore. This was the start of building a 
					lightweight analytics layer for counts of pending tasks, overdue tasks, and which 
					deadline is coming up next. Luckily, firestore queries are pretty straight forward 
					with their code syntax.
				</p>
				<h3>üîç Querying Assignments by Time Windows (Weekly Deadlines)</h3>
				<p>
					To calculate ‚Äútasks due this week,‚Äù I used startOfWeek, endOfWeek from a date 
					library, and Firestore range filters:
					
					<pre><code class="language-tsx">
						const start = startOfWeek(new Date())
						const end = endOfWeek(new Date())

						const q = query(
							collection(db, 'assignments'),
							where('consultant', '==', consultantRef),
							where('dueDate', '>=', Timestamp.fromDate(start)),
							where('dueDate', '<=', Timestamp.fromDate(end)),
							where('status', '==', 'Pending')
						)
					</code></pre>

					<br></br>

					Finding the Soonest Deadline - 
					Firestore makes it simple to fetch ‚Äúnext upcoming assignment‚Äù using orderBy + limit:
					<pre><code class="language-tsx">
							const q = query(
							collection(db, 'assignments'),
							where('consultant', '==', consultantRef),
							where('dueDate', '>=', Timestamp.fromDate(new Date())),
							orderBy('dueDate', 'asc'),
							limit(1)
						)
					</code></pre>
				</p>
				<h2>What I Learned</h2>
				<p>
					<h3>Firebase Queries</h3>
					<ul>
						<li>
							Firestore queries for an analytics layer of your data.
						</li>
						<li>
							orderBy + limit(1) is a clean pattern for ‚Äúnext deadline‚Äù queries.
						</li>
					</ul>

					<h3>Firebase & Auth</h3>
					<ul>
						<li>
							Hard refreshes trigger server-side rendering, which breaks authenticated Firestore reads.						</li>
						<li>
							Data fetching must wait for onAuthStateChanged before dispatching thunks.						</li>
					</ul>
				</p>
				<h2>What's Next</h2>
				<p>
					I need to get some more core functionality with my app done. So I'll be focusing on the 
					updating part of CRUD for assignments.
					<ul>
						<li>
							Work on file uploads
						</li>
						<li>
							Get the Create and Update of CRUD for assignments and entries for the timeline
						</li>
					</ul>
				</p>
				<footer>
					<!-- <ul class="stats">
						<li><a href="#">General</a></li>
						<li><a href="#" class="icon solid fa-heart">28</a></li>
						<li><a href="#" class="icon solid fa-comment">128</a></li>
					</ul> -->
				</footer>
			</article>

		</div>

		<!-- Footer -->
		<section id="footer">
			<ul class="icons">
				<li><a href="https://www.linkedin.com/in/charles-cruse-2ba72ab6/"
						class="icon brands fa-linkedin fa-lg"><span class="label">LinkedIn</span></a></li>
				<li><a href="https://github.com/cruse-charles" class="icon brands fa-github fa-lg"><span
							class="label">Github</span></a></li>
				<li><a href="mailto:charlesncruse@gmail.com" class="icon solid fa-envelope fa-lg"><span
							class="label">Email</span></a></li>
			</ul>
			<p class="copyright">&copy; Untitled. Design: <a href="http://html5up.net">HTML5 UP</a>.
		</section>

	</div>

	<!-- Scripts -->
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/browser.min.js"></script>
	<script src="assets/js/breakpoints.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script>

</body>

</html>